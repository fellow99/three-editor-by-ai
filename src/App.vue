<script setup>
// 3D场景编辑器主应用组件
import { ref, reactive, provide, onMounted, onUnmounted } from 'vue';
import { useScene } from './composables/useScene.js';
import { useObjectSelection } from './composables/useObjectSelection.js';
import { useTransform } from './composables/useTransform.js';
import { useAssets } from './composables/useAssets.js';

// 导入组件
import Toolbar from './components/editor/Toolbar.vue';
import AssetBrowser from './components/editor/AssetBrowser.vue';
import Inspector from './components/editor/Inspector.vue';
import SceneViewer from './components/scene/SceneViewer.vue';
import PropertyPanel from './components/editor/PropertyPanel.vue';

// 应用状态管理
const appState = reactive({
  isLoading: true,
  leftPanelCollapsed: false,
  rightPanelCollapsed: false,
  bottomPanelCollapsed: true,
  activeLeftTab: 'assets', // 'assets' | 'inspector'
  panels: {
    leftWidth: 300,
    rightWidth: 300,
    bottomHeight: 200
  }
});

// 使用各种 composables
const scene = useScene();
const objectSelection = useObjectSelection();
const transform = useTransform();
const assets = useAssets();

// 提供给子组件使用
provide('scene', scene);
provide('objectSelection', objectSelection);
provide('transform', transform);
provide('assets', assets);
provide('appState', appState);

// 键盘快捷键处理
function handleKeyboard(event) {
  // 阻止某些默认行为
  if (event.ctrlKey || event.metaKey) {
    switch (event.code) {
      case 'KeyS':
        event.preventDefault();
        // 保存场景
        break;
      case 'KeyZ':
        event.preventDefault();
        if (event.shiftKey) {
          // 重做
          transform.redo?.();
        } else {
          // 撤销
          transform.undo?.();
        }
        break;
      case 'KeyD':
        event.preventDefault();
        // 复制对象
        if (objectSelection.hasSelection.value) {
          // TODO: 实现复制功能
        }
        break;
    }
  }
  
  // 单键快捷键
  switch (event.code) {
    case 'Delete':
      if (objectSelection.hasSelection.value) {
        if (confirm('确定要删除选中的对象吗？')) {
          const selectedIds = Array.from(objectSelection.selectedObjectIds.value);
          selectedIds.forEach(id => {
            scene.removeObjectFromScene(id);
          });
          objectSelection.clearSelection();
        }
      }
      break;
    case 'KeyF':
      if (objectSelection?.hasSelection?.value) {
        const selectedObjects = objectSelection.selectedObjects.value;
        if (selectedObjects?.length > 0) {
          scene.focusOnObject?.(selectedObjects[0]);
        }
      }
      break;
    case 'Escape':
      objectSelection?.clearSelection?.();
      break;
  }
}

// 面板控制方法
function toggleLeftPanel() {
  appState.leftPanelCollapsed = !appState.leftPanelCollapsed;
}

function toggleRightPanel() {
  appState.rightPanelCollapsed = !appState.rightPanelCollapsed;
}

function setActiveLeftTab(tab) {
  appState.activeLeftTab = tab;
  if (appState.leftPanelCollapsed) {
    appState.leftPanelCollapsed = false;
  }
}

// 生命周期
onMounted(() => {
  // 添加键盘事件监听
  document.addEventListener('keydown', handleKeyboard);
  
  // 应用加载完成
  setTimeout(() => {
    appState.isLoading = false;
  }, 1000);
});

onUnmounted(() => {
  // 清理事件监听器
  document.removeEventListener('keydown', handleKeyboard);
});
</script>

<template>
  <div id="app" class="editor-container">
    <!-- 加载遮罩 -->
    <div v-if="appState.isLoading" class="loading-overlay">
      <div class="loading-content">
        <div class="loading-spinner"></div>
        <h2>3D 场景编辑器</h2>
        <p>正在初始化编辑器...</p>
      </div>
    </div>

    <!-- 顶部工具栏 -->
    <header class="editor-header">
      <div class="header-left">
        <button 
          @click="toggleLeftPanel" 
          class="panel-toggle-btn"
          :class="{ active: !appState.leftPanelCollapsed }"
          title="切换左侧面板"
        >
          ☰
        </button>
        <h1>3D 场景编辑器</h1>
      </div>
      
      <div class="header-center">
        <!-- 可以添加一些中央控制按钮 -->
      </div>
      
      <div class="header-right">
        <button 
          @click="toggleRightPanel" 
          class="panel-toggle-btn"
          :class="{ active: !appState.rightPanelCollapsed }"
          title="切换右侧面板"
        >
          ⚙️
        </button>
      </div>
    </header>
    
    <!-- 主工具栏 -->
    <div class="main-toolbar">
      <Toolbar />
    </div>
    
    <!-- 主编辑区域 -->
    <main class="editor-main">
      <!-- 左侧面板 -->
      <div 
        v-if="!appState.leftPanelCollapsed" 
        class="editor-sidebar left-panel"
        :style="{ width: appState.panels.leftWidth + 'px' }"
      >
        <!-- 标签页头部 -->
        <div class="panel-tabs">
          <button 
            @click="setActiveLeftTab('assets')" 
            :class="['tab-btn', { active: appState.activeLeftTab === 'assets' }]"
          >
            📦 资源
          </button>
          <button 
            @click="setActiveLeftTab('inspector')" 
            :class="['tab-btn', { active: appState.activeLeftTab === 'inspector' }]"
          >
            🔍 层级
          </button>
        </div>
        
        <!-- 标签页内容 -->
        <div class="panel-content">
          <AssetBrowser v-show="appState.activeLeftTab === 'assets'" />
          <Inspector v-show="appState.activeLeftTab === 'inspector'" />
        </div>
      </div>
      
      <!-- 主场景视口 -->
      <div class="editor-viewport">
        <SceneViewer />
      </div>
      
      <!-- 右侧属性面板 -->
      <div 
        v-if="!appState.rightPanelCollapsed" 
        class="editor-sidebar right-panel"
        :style="{ width: appState.panels.rightWidth + 'px' }"
      >
        <PropertyPanel />
      </div>
    </main>

    <!-- 状态栏 -->
    <footer class="editor-footer">
      <div class="footer-left">
        <span class="status-item">
          {{ objectSelection?.hasSelection?.value ? `已选中 ${objectSelection?.selectionCount?.value || 0} 个对象` : '未选中对象' }}
        </span>
      </div>
      
      <div class="footer-center">
        <span class="status-item">
          相机: {{ scene?.cameraState?.fov || 75 }}° FOV
        </span>
      </div>
      
      <div class="footer-right">
        <span class="status-item">
          FPS: {{ scene?.fps?.value || 0 }}
        </span>
        <span class="status-item">
          对象数: {{ scene?.getSceneStats?.()?.objects || 0 }}
        </span>
      </div>
    </footer>
  </div>
</template>

<style scoped>
.editor-container {
  height: 100vh;
  display: flex;
  flex-direction: column;
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  background: #1a1a1a;
  color: #fff;
}

/* 加载遮罩 */
.loading-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: linear-gradient(135deg, #1a1a1a 0%, #2a2a2a 100%);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 9999;
}

.loading-content {
  text-align: center;
  color: #fff;
}

.loading-spinner {
  width: 60px;
  height: 60px;
  border: 4px solid #333;
  border-top: 4px solid #007acc;
  border-radius: 50%;
  animation: spin 1s linear infinite;
  margin: 0 auto 24px;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

.loading-content h2 {
  margin: 0 0 12px 0;
  font-size: 24px;
  font-weight: 600;
  color: #fff;
}

.loading-content p {
  margin: 0;
  color: #aaa;
  font-size: 14px;
}

/* 顶部标题栏 */
.editor-header {
  height: 48px;
  background: #2a2a2a;
  border-bottom: 1px solid #444;
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 0 16px;
  color: #fff;
}

.header-left,
.header-center,
.header-right {
  display: flex;
  align-items: center;
  gap: 12px;
}

.header-left h1 {
  margin: 0;
  font-size: 16px;
  font-weight: 600;
  color: #fff;
}

.panel-toggle-btn {
  width: 32px;
  height: 32px;
  background: transparent;
  border: 1px solid #555;
  border-radius: 4px;
  color: #aaa;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 14px;
  transition: all 0.2s;
}

.panel-toggle-btn:hover {
  background: #444;
  border-color: #777;
  color: #fff;
}

.panel-toggle-btn.active {
  background: #007acc;
  border-color: #0088dd;
  color: #fff;
}

/* 主工具栏 */
.main-toolbar {
  border-bottom: 1px solid #444;
}

/* 主编辑区域 */
.editor-main {
  flex: 1;
  display: flex;
  overflow: hidden;
}

/* 侧边栏 */
.editor-sidebar {
  background: #2a2a2a;
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

.left-panel {
  border-right: 1px solid #444;
}

.right-panel {
  border-left: 1px solid #444;
}

/* 面板标签页 */
.panel-tabs {
  display: flex;
  background: #333;
  border-bottom: 1px solid #444;
}

.tab-btn {
  flex: 1;
  padding: 12px 16px;
  background: transparent;
  border: none;
  border-bottom: 2px solid transparent;
  color: #aaa;
  font-size: 12px;
  cursor: pointer;
  transition: all 0.2s;
}

.tab-btn:hover {
  background: #444;
  color: #fff;
}

.tab-btn.active {
  background: #2a2a2a;
  border-bottom-color: #007acc;
  color: #fff;
}

/* 面板内容 */
.panel-content {
  flex: 1;
  overflow: hidden;
  display: flex;
  flex-direction: column;
}

/* 主视口 */
.editor-viewport {
  flex: 1;
  background: #1a1a1a;
  position: relative;
  overflow: hidden;
}

/* 状态栏 */
.editor-footer {
  height: 28px;
  background: #2a2a2a;
  border-top: 1px solid #444;
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 0 16px;
  font-size: 11px;
  color: #aaa;
}

.footer-left,
.footer-center,
.footer-right {
  display: flex;
  align-items: center;
  gap: 16px;
}

.status-item {
  padding: 2px 8px;
  background: #333;
  border-radius: 3px;
  font-family: monospace;
}

/* 响应式设计 */
@media (max-width: 1024px) {
  .editor-sidebar {
    width: 280px !important;
  }
  
  .header-left h1 {
    font-size: 14px;
  }
  
  .panel-toggle-btn {
    width: 28px;
    height: 28px;
    font-size: 12px;
  }
}

@media (max-width: 768px) {
  .editor-header {
    height: 44px;
    padding: 0 12px;
  }
  
  .header-left h1 {
    font-size: 12px;
  }
  
  .editor-sidebar {
    width: 260px !important;
  }
  
  .tab-btn {
    padding: 10px 12px;
    font-size: 11px;
  }
  
  .editor-footer {
    height: 24px;
    padding: 0 12px;
    font-size: 10px;
  }
  
  .footer-center {
    display: none;
  }
}

/* 深色主题优化 */
:deep(.panel),
:deep(.asset-browser),
:deep(.inspector),
:deep(.property-panel) {
  background: #2a2a2a;
  color: #fff;
}

/* 滚动条样式 */
:deep(*::-webkit-scrollbar) {
  width: 8px;
  height: 8px;
}

:deep(*::-webkit-scrollbar-track) {
  background: #333;
}

:deep(*::-webkit-scrollbar-thumb) {
  background: #555;
  border-radius: 4px;
}

:deep(*::-webkit-scrollbar-thumb:hover) {
  background: #666;
}

/* 选择文本颜色 */
::selection {
  background: #007acc;
  color: #fff;
}

:deep(::selection) {
  background: #007acc;
  color: #fff;
}
</style>

/**
 * 场景管理器
 * 负责Three.js场景的创建、管理和渲染
 */

import * as THREE from 'three';
import { OrbitControls } from 'three/examples/jsm/controls/OrbitControls.js';
// 引入FlyControls用于飞行模式控制
import { FlyControls } from 'three/examples/jsm/controls/FlyControls.js';
import { EffectComposer } from 'three/examples/jsm/postprocessing/EffectComposer.js';
import { RenderPass } from 'three/examples/jsm/postprocessing/RenderPass.js';
import { reactive } from 'vue';

/**
 * SceneManager
 * Three.js场景、渲染器、相机、控制器、后处理等统一管理类
 */
class SceneManager {
  /**
   * Three.js场景管理器，支持OrbitControls和FlyControls切换
   */
  constructor() {
    this.scene = null;
    this.renderer = null;
    this.camera = null;
    this.controls = null; // OrbitControls实例
    this.flyControls = null; // FlyControls实例
    this.isFlyControlEnabled = false; // 是否启用FlyControls
    this.container = null;
    this.animationId = null;

    // 后处理
    this.composer = null;
    this.passes = [];

    // 响应式状态
    this.state = reactive({
      isInitialized: false,
      isRendering: false,
      frameCount: 0,
      fps: 0
    });
    
    // 性能监控
    this.lastTime = 0;
    this.frameCount = 0;
    
    // 事件监听器
    this.resizeHandler = this.handleResize.bind(this);
    
    this.init();
  }
  
  /**
   * 初始化场景
   */
  init() {
    this.createScene();
    this.createRenderer();
    this.createCamera();
    this.setupLights();

    // 初始化后处理
    this.initComposer();

    this.state.isInitialized = true;
  }
  
  /**
   * 创建场景
   */
  createScene() {
    this.scene = new THREE.Scene();
    this.scene.background = new THREE.Color(0x222222);
    this.scene.fog = new THREE.Fog(0x222222, 1000, 10000);
  }
  
  /**
   * 创建渲染器
   */
  createRenderer() {
    this.renderer = new THREE.WebGLRenderer({
      antialias: true,
      alpha: true,
      powerPreference: 'high-performance'
    });

    this.renderer.setSize(800, 600);
    this.renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
    this.renderer.shadowMap.enabled = true;
    this.renderer.shadowMap.type = THREE.PCFSoftShadowMap;
    this.renderer.outputEncoding = THREE.sRGBEncoding;
    this.renderer.toneMapping = THREE.ACESFilmicToneMapping;
    this.renderer.toneMappingExposure = 1;
  }

  /**
   * 初始化后处理
   */
  initComposer() {
    if (this.renderer && this.scene && this.camera) {
      this.composer = new EffectComposer(this.renderer);
      const renderPass = new RenderPass(this.scene, this.camera);
      this.composer.addPass(renderPass);
      this.passes = [renderPass];
    }
  }

  /**
   * 添加后处理Pass
   * @param {Pass} pass
   * @param {number} index
   */
  addPass(pass, index) {
    if (!this.composer) return;
    if (typeof index === 'number' && index >= 0 && index < this.composer.passes.length) {
      this.composer.passes.splice(index, 0, pass);
      this.composer.addPass(pass);
      this.passes.splice(index, 0, pass);
    } else {
      this.composer.addPass(pass);
      this.passes.push(pass);
    }
  }

  /**
   * 移除后处理Pass
   * @param {Pass} pass
   */
  removePass(pass) {
    if (!this.composer) return;
    const idx = this.composer.passes.indexOf(pass);
    if (idx > -1) {
      this.composer.passes.splice(idx, 1);
      this.passes.splice(idx, 1);
    }
  }

  /**
   * 修改指定Pass参数
   * @param {Pass} pass
   * @param {object} params
   */
  setPassParams(pass, params) {
    if (!pass || !params) return;
    Object.entries(params).forEach(([key, value]) => {
      if (key in pass) {
        pass[key] = value;
      }
    });
  }
  
  /**
   * 创建相机
   */
  createCamera() {
    this.camera = new THREE.PerspectiveCamera(
      75, // fov
      800 / 600, // aspect
      0.1, // near
      1000 // far
    );
    
    this.camera.position.set(5, 5, 5);
    this.camera.lookAt(0, 0, 0);
  }
  
  /**
   * 设置光照
   */
  setupLights() {
    // 环境光
    const ambientLight = new THREE.AmbientLight(0x404040, 0.4);
    this.scene.add(ambientLight);
    
    // 方向光
    const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
    directionalLight.position.set(50, 50, 50);
    directionalLight.castShadow = true;
    directionalLight.shadow.mapSize.width = 2048;
    directionalLight.shadow.mapSize.height = 2048;
    directionalLight.shadow.camera.near = 0.5;
    directionalLight.shadow.camera.far = 500;
    directionalLight.shadow.camera.left = -50;
    directionalLight.shadow.camera.right = 50;
    directionalLight.shadow.camera.top = 50;
    directionalLight.shadow.camera.bottom = -50;
    this.scene.add(directionalLight);
    
    // 点光源
    const pointLight = new THREE.PointLight(0xffffff, 0.5, 100);
    pointLight.position.set(-20, 20, 20);
    pointLight.castShadow = true;
    this.scene.add(pointLight);
    
    // 添加网格地面
    this.setupGrid();
  }
  
  /**
   * 设置网格地面
   */
  setupGrid() {
    // 只创建一次
    if (!this.gridHelper) {
      this.gridHelper = new THREE.GridHelper(20, 20, 0x888888, 0x444444);
      this.gridHelper.name = 'grid_helper';
      this.scene.add(this.gridHelper);
    }
    // 添加坐标轴
    if (!this.axesHelper) {
      this.axesHelper = new THREE.AxesHelper(5);
      this.axesHelper.name = 'axes_helper';
      this.scene.add(this.axesHelper);
    }
  }

  /**
   * 控制网格和坐标轴显示/隐藏
   * @param {boolean} visible
   */
  setGridVisible(visible) {
    if (this.gridHelper) {
      this.gridHelper.visible = visible;
    }
    if (this.axesHelper) {
      this.axesHelper.visible = visible;
    }
  }
  
  /**
   * 设置容器
   * @param {HTMLElement} container DOM容器
   */
  setContainer(container) {
    this.container = container;
    if (container && this.renderer) {
      container.appendChild(this.renderer.domElement);
      this.setupControls();
      this.setupFlyControls();
      this.handleResize();
      window.addEventListener('resize', this.resizeHandler);
    }
  }
  
  /**
   * 设置OrbitControls
   */
  setupControls() {
    if (!this.camera || !this.renderer) return;
    this.controls = new OrbitControls(this.camera, this.renderer.domElement);
    // 配置控制器
    this.controls.enableDamping = false; // 禁用惯性移动
    this.controls.dampingFactor = 0.05;
    this.controls.screenSpacePanning = false;
    this.controls.minDistance = 1;
    this.controls.maxDistance = 500;
    this.controls.maxPolarAngle = Math.PI;
    // 设置控制器速度
    this.controls.rotateSpeed = 1.0;
    this.controls.zoomSpeed = 1.0;
    this.controls.panSpeed = 1.0;
    // 设置目标点
    this.controls.target.set(0, 0, 0);
    this.controls.update();
  }

  /**
   * 设置FlyControls
   * 仅初始化一次，默认不启用
   */
  setupFlyControls() {
    if (!this.camera || !this.renderer) return;
    this.flyControls = new FlyControls(this.camera, this.renderer.domElement);
    // FlyControls参数可根据需要调整
    this.flyControls.movementSpeed = 10;
    this.flyControls.rollSpeed = Math.PI / 12;
    this.flyControls.autoForward = false;
    this.flyControls.dragToLook = true;
    this.flyControls.enabled = false;
  }

  /**
   * 启用或禁用FlyControls
   * @param {boolean} enabled 是否启用飞行控制
   */
  setFlyControlEnabled(enabled) {
    this.isFlyControlEnabled = enabled;
    if (this.flyControls) this.flyControls.enabled = enabled;
    if (this.controls) this.controls.enabled = !enabled;
  }
  
  /**
   * 更新控制器配置
   * @param {object} config 控制器配置
   */
  updateControlsConfig(config) {
    if (!this.controls) return;
    
    Object.entries(config).forEach(([key, value]) => {
      if (this.controls.hasOwnProperty(key)) {
        this.controls[key] = value;
      }
    });
    
    this.controls.update();
  }
  
  /**
   * 处理窗口大小变化
   */
  handleResize() {
    if (!this.container || !this.renderer || !this.camera) return;

    const width = this.container.clientWidth;
    const height = this.container.clientHeight;

    this.camera.aspect = width / height;
    this.camera.updateProjectionMatrix();

    this.renderer.setSize(width, height);
    if (this.composer) {
      this.composer.setSize(width, height);
    }
  }
  
  /**
   * 开始渲染循环
   */
  startRender() {
    if (this.state.isRendering) return;
    
    this.state.isRendering = true;
    this.lastTime = performance.now();
    this.animate();
  }
  
  /**
   * 停止渲染循环
   */
  stopRender() {
    if (this.animationId) {
      cancelAnimationFrame(this.animationId);
      this.animationId = null;
    }
    this.state.isRendering = false;
  }
  
  /**
   * 动画循环
   */
  animate() {
    this.animationId = requestAnimationFrame(() => this.animate());
    // 计算FPS
    const currentTime = performance.now();
    this.frameCount++;
    if (currentTime - this.lastTime >= 1000) {
      this.state.fps = Math.round((this.frameCount * 1000) / (currentTime - this.lastTime));
      this.frameCount = 0;
      this.lastTime = currentTime;
    }
    this.render();
    this.state.frameCount++;
  }

  /**
   * 渲染场景
   * 根据控制器类型更新
   */
  render() {
    // 更新控制器
    if (this.isFlyControlEnabled && this.flyControls) {
      // 动态调整速度：根据相机到视点距离
      let target = this.controls ? this.controls.target : new THREE.Vector3(0, 0, 0);
      let camPos = this.camera ? this.camera.position : new THREE.Vector3(0, 0, 0);
      let distance = camPos.distanceTo(target);
      // 距离越远速度越快，越近越慢（限制最小最大值）
      this.flyControls.movementSpeed = Math.max(0.5, Math.min(20, distance * 0.6));
      this.flyControls.rollSpeed = Math.max(Math.PI / 36, Math.min(Math.PI / 6, distance * 0.04));
      this.flyControls.update(0.1);
    } else if (this.controls) {
      this.controls.update();
    }
    if (this.composer) {
      this.composer.render();
    } else if (this.renderer && this.scene && this.camera) {
      this.renderer.render(this.scene, this.camera);
    }
  }
  
  /**
   * 添加对象到场景
   * @param {THREE.Object3D} object 3D对象
   */
  addObject(object) {
    this.scene.add(object);
  }
  
  /**
   * 从场景移除对象
   * @param {THREE.Object3D} object 3D对象
   */
  removeObject(object) {
    let idx = this.scene.children.findIndex(child => child === object || child.uuid === object.uuid);
    if (idx > -1) {
      this.scene.remove(object);
      
      let idx2 = this.scene.children.findIndex(child => child === object || child.uuid === object.uuid);
      // 如果常规移除失败，尝试强制移除
      if (idx2 > -1) {
          this.scene.children.splice(idx2, 1);
      }
    }
  }
  
  /**
   * 清空场景
   */
  clearScene() {
    while (this.scene.children.length > 0) {
      const child = this.scene.children[0];
      this.scene.remove(child);
      
      // 清理几何体和材质
      if (child.geometry) {
        child.geometry.dispose();
      }
      if (child.material) {
        if (Array.isArray(child.material)) {
          child.material.forEach(material => material.dispose());
        } else {
          child.material.dispose();
        }
      }
    }
    
    // 重新设置光照
    this.setupLights();
  }
  
  /**
   * 设置场景背景
   * @param {THREE.Color|THREE.Texture} background 背景
   */
  setBackground(background) {
    this.scene.background = background;
  }
  
  /**
   * 获取场景对象列表
   * @returns {THREE.Object3D[]} 对象列表
   */
  getObjects() {
    return this.scene.children.filter(child => 
      !(child instanceof THREE.Light) && 
      !(child instanceof THREE.Camera)
    );
  }
  
  /**
   * 根据名称查找对象
   * @param {string} name 对象名称
   * @returns {THREE.Object3D|null} 找到的对象
   */
  findObjectByName(name) {
    return this.scene.getObjectByName(name);
  }
  
  /**
   * 导出场景数据
   * @returns {object} 场景数据
   */
  exportScene() {
    const sceneData = {
      objects: [],
      lights: [],
      camera: {
        position: this.camera.position.toArray(),
        rotation: this.camera.rotation.toArray(),
        fov: this.camera.fov,
        near: this.camera.near,
        far: this.camera.far
      },
      background: this.scene.background instanceof THREE.Color ? 
        this.scene.background.getHex() : null
    };
    
    this.scene.children.forEach(child => {
      if (child instanceof THREE.Light) {
        sceneData.lights.push({
          type: child.type,
          position: child.position.toArray(),
          color: child.color.getHex(),
          intensity: child.intensity
        });
      } else if (!(child instanceof THREE.Camera)) {
        sceneData.objects.push({
          name: child.name,
          type: child.type,
          position: child.position.toArray(),
          rotation: child.rotation.toArray(),
          scale: child.scale.toArray()
        });
      }
    });
    
    return sceneData;
  }
  
  /**
   * 销毁场景管理器
   */
  dispose() {
    this.stopRender();
    
    if (this.container && this.resizeHandler) {
      window.removeEventListener('resize', this.resizeHandler);
    }
    
    // 清理控制器
    if (this.controls) {
      this.controls.dispose();
      this.controls = null;
    }
    
    this.clearScene();

    if (this.composer) {
      this.composer = null;
      this.passes = [];
    }

    if (this.renderer) {
      this.renderer.dispose();
    }
  }
}

// 单例模式
let instance = null;

export function useSceneManager() {
  if (!instance) {
    instance = new SceneManager();
  }
  return instance;
}

export default SceneManager;

/**
 * @class VfsServerApi
 * vfs-server服务的封装类
 */
export class VfsServerApi {
    /**
     * 构造函数
     * @param {Object} opt 配置项，包含 drive、baseURL、root
     */
    constructor (opt) {
        let { drive, baseURL, root } = opt;
        this._drive = drive || 'xx';
        this._baseURL = baseURL || '';
        this._root = root;
    }

    /**
     * 获取目录内容
     * @param {string} path 目录路径
     * @returns {Promise<Object>} 目录内容的JSON对象
     */
    async list (path) {
        let drive = this._drive;
        let root = this._root;
        root = (root === '/' ? '' : root);
        let url = `${this._baseURL}${root}/api/list/${drive}?path=${path}`;
        try {
            const res = await fetch(url);
            if (!res.ok) throw new Error('Network response was not ok');
            let json = await res.json();
            json && json.data && json.data.files && json.data.files.forEach(item=>{
                if(item.path.startsWith('./')){
                    // 去掉开头的.
                    item.path = item.path.substring(1);
                }
            })
            return json;
        } catch (e) {
            throw e;
        }
    }

    /**
     * 获取文件的访问链接
     * @param {string} path 文件路径
     * @returns {string} 文件URL
     */
    url (path) {
        let drive = this._drive;
        let root = this._root;
        root = (root === '/' ? '' : root);
        path = (path === '/' ? '' : path);
        let url = `${root}/file/${drive}${path}`;
        return url;
    }

    /**
     * 获取文件的文本内容
     * @param {string} path 文件路径
     * @returns {Promise<string>} 文件文本内容
     */
    async content (path) {
        let drive = this._drive;
        let root = this._root;
        root = (root === '/' ? '' : root);
        path = (path === '/' ? '' : path);
        let url = `${this._baseURL}${root}/file/${drive}${path}`;
        try {
            const res = await fetch(url);
            if (!res.ok) throw new Error('Network response was not ok');
            return await res.text();
        } catch (e) {
            throw e;
        }
    }

    /**
     * 获取文件内容，自动转为json
     * @param {string} path 文件路径
     * @returns {Promise<Object>} 文件内容的JSON对象
     */
    async json (path) {
        let drive = this._drive;
        let root = this._root;
        root = (root === '/' ? '' : root);
        path = (path === '/' ? '' : path);
        let url = `${this._baseURL}${root}/file/${drive}${path}`;
        try {
            const res = await fetch(url);
            if (!res.ok) throw new Error('Network response was not ok');
            return await res.json();
        } catch (e) {
            throw e;
        }
    }

    /**
     * 获取文件内容，返回Blob对象
     * @param {string} path 文件路径
     * @returns {Promise<Blob>} 文件内容的Blob对象
     */
    async blob (path) {
        let drive = this._drive;
        let root = this._root;
        root = (root === '/' ? '' : root);
        path = (path === '/' ? '' : path);
        let url = `${this._baseURL}${root}/file/${drive}${path}`;
        try {
            const res = await fetch(url);
            if (!res.ok) throw new Error('Network response was not ok');
            return await res.blob();
        } catch (e) {
            throw e;
        }
    }

    /**
     * 判断文件路径是否存在
     * @param {string} path 文件路径
     * @returns {Promise<boolean>} 是否存在
     */
    async exists (path) {
        let drive = this._drive;
        let root = this._root;
        root = (root === '/' ? '' : root);
        path = (path === '/' ? '' : path);
        let url = `${this._baseURL}${root}/exists/${drive}${path}`;
        try {
            const res = await fetch(url);
            if (!res.ok) return false;
            const json = await res.json();
            return json && json.exists;
        } catch (e) {
            return false;
        }
    }

    /**
     * 保存文件内容
     * @param {string} path 文件路径
     * @param {string} text 文件文本内容
     * @returns {Promise<boolean>} 是否保存成功
     */
    async save (path, text) {
        let drive = this._drive;
        let root = this._root;
        root = (root === '/' ? '' : root);
        path = (path === '/' ? '' : path);
        let url = `${this._baseURL}${root}/save/${drive}${path}`;
        try {
            let body = text;
            let headers = {'Content-Type': 'text/plain'};
            const res = await fetch(url, { method: 'POST', body, headers });
            if (!res.ok) return false;
            const json = await res.json();
            return json && json.success;
        } catch (e) {
            return false;
        }
    }
}

<template>
  <div class="toolbar">
    <!-- æ–‡ä»¶æ“ä½œ -->
    <div class="toolbar-section">
      <button 
        @click="newScene" 
        class="toolbar-btn"
        title="æ–°å»ºåœºæ™¯"
      >
        <span class="icon">ğŸ“„</span>
        æ–°å»º
      </button>
      <button 
        @click="saveScene" 
        class="toolbar-btn"
        title="ä¿å­˜åœºæ™¯"
      >
        <span class="icon">ğŸ’¾</span>
        ä¿å­˜
      </button>
      <button 
        @click="loadScene" 
        class="toolbar-btn"
        title="åŠ è½½åœºæ™¯"
      >
        <span class="icon">ğŸ“‚</span>
        åŠ è½½
      </button>
    </div>

    <div class="toolbar-divider"></div>

    <!-- åŸºç¡€å‡ ä½•ä½“ -->
    <div class="toolbar-section">
      <span class="section-label">æ·»åŠ :</span>
      <button 
        @click="addPrimitive('box')" 
        class="toolbar-btn primitive-btn"
        title="æ·»åŠ ç«‹æ–¹ä½“"
      >
        <span class="icon">â¬œ</span>
        ç«‹æ–¹ä½“
      </button>
      <button 
        @click="addPrimitive('sphere')" 
        class="toolbar-btn primitive-btn"
        title="æ·»åŠ çƒä½“"
      >
        <span class="icon">âšª</span>
        çƒä½“
      </button>
      <button 
        @click="addPrimitive('cylinder')" 
        class="toolbar-btn primitive-btn"
        title="æ·»åŠ åœ†æŸ±ä½“"
      >
        <span class="icon">ğŸ¥«</span>
        åœ†æŸ±ä½“
      </button>
      <button 
        @click="addPrimitive('plane')" 
        class="toolbar-btn primitive-btn"
        title="æ·»åŠ å¹³é¢"
      >
        <span class="icon">â–­</span>
        å¹³é¢
      </button>
    </div>

    <div class="toolbar-divider"></div>

    <!-- å˜æ¢å·¥å…· -->
    <div class="toolbar-section">
      <span class="section-label">å·¥å…·:</span>
      <button 
        @click="setTransformMode('translate')" 
        :class="['toolbar-btn', 'tool-btn', { active: transformMode === 'translate' }]"
        title="ç§»åŠ¨å·¥å…· (G)"
      >
        <span class="icon">â†”ï¸</span>
        ç§»åŠ¨
      </button>
      <button 
        @click="setTransformMode('rotate')" 
        :class="['toolbar-btn', 'tool-btn', { active: transformMode === 'rotate' }]"
        title="æ—‹è½¬å·¥å…· (R)"
      >
        <span class="icon">ğŸ”„</span>
        æ—‹è½¬
      </button>
      <button 
        @click="setTransformMode('scale')" 
        :class="['toolbar-btn', 'tool-btn', { active: transformMode === 'scale' }]"
        title="ç¼©æ”¾å·¥å…· (S)"
      >
        <span class="icon">ğŸ“</span>
        ç¼©æ”¾
      </button>
    </div>

    <div class="toolbar-divider"></div>

    <!-- é€‰æ‹©å·¥å…· -->
    <div class="toolbar-section">
      <span class="section-label">é€‰æ‹©:</span>
      <button 
        @click="setSelectionMode('single')" 
        :class="['toolbar-btn', 'selection-btn', { active: selectionMode === 'single' }]"
        title="å•é€‰æ¨¡å¼"
      >
        <span class="icon">ğŸ‘†</span>
        å•é€‰
      </button>
      <button 
        @click="setSelectionMode('multiple')" 
        :class="['toolbar-btn', 'selection-btn', { active: selectionMode === 'multiple' }]"
        title="å¤šé€‰æ¨¡å¼"
      >
        <span class="icon">ğŸ‘‡</span>
        å¤šé€‰
      </button>
      <button 
        @click="setSelectionMode('box')" 
        :class="['toolbar-btn', 'selection-btn', { active: selectionMode === 'box' }]"
        title="æ¡†é€‰æ¨¡å¼"
      >
        <span class="icon">â¬š</span>
        æ¡†é€‰
      </button>
    </div>

    <div class="toolbar-divider"></div>

    <!-- ç¼–è¾‘æ“ä½œ -->
    <div class="toolbar-section">
      <button 
        @click="undo" 
        :disabled="!canUndo"
        class="toolbar-btn"
        title="æ’¤é”€ (Ctrl+Z)"
      >
        <span class="icon">â†¶</span>
        æ’¤é”€
      </button>
      <button 
        @click="redo" 
        :disabled="!canRedo"
        class="toolbar-btn"
        title="é‡åš (Ctrl+Y)"
      >
        <span class="icon">â†·</span>
        é‡åš
      </button>
      <button 
        @click="duplicateSelected" 
        :disabled="!hasSelection"
        class="toolbar-btn"
        title="å¤åˆ¶ (Ctrl+D)"
      >
        <span class="icon">ğŸ“‹</span>
        å¤åˆ¶
      </button>
      <button 
        @click="deleteSelected" 
        :disabled="!hasSelection"
        class="toolbar-btn danger"
        title="åˆ é™¤ (Delete)"
      >
        <span class="icon">ğŸ—‘ï¸</span>
        åˆ é™¤
      </button>
    </div>

    <div class="toolbar-divider"></div>

    <!-- è§†å›¾æ§åˆ¶ -->
    <div class="toolbar-section">
      <span class="section-label">è§†å›¾:</span>
      <button 
        @click="focusSelected" 
        :disabled="!hasSelection"
        class="toolbar-btn"
        title="èšç„¦åˆ°é€‰ä¸­å¯¹è±¡ (F)"
      >
        <span class="icon">ğŸ¯</span>
        èšç„¦
      </button>
      <button 
        @click="resetCamera" 
        class="toolbar-btn"
        title="é‡ç½®ç›¸æœº"
      >
        <span class="icon">ğŸ“·</span>
        é‡ç½®ç›¸æœº
      </button>
    </div>

    <div class="toolbar-divider"></div>

    <!-- è®¾ç½® -->
    <div class="toolbar-section">
      <label class="toggle-label">
        <input 
          v-model="snapToGrid" 
          type="checkbox"
          @change="updateSnapToGrid"
        >
        <span class="toggle-text">ç½‘æ ¼å¸é™„</span>
      </label>
      <label class="toggle-label">
        <input 
          v-model="showWireframe" 
          type="checkbox"
          @change="updateWireframe"
        >
        <span class="toggle-text">çº¿æ¡†æ¨¡å¼</span>
      </label>
    </div>

    <!-- å³ä¾§çŠ¶æ€ä¿¡æ¯ -->
    <div class="toolbar-status">
      <span class="status-item">
        é€‰ä¸­: {{ selectionCount }}
      </span>
      <span class="status-item">
        FPS: {{ fps }}
      </span>
      <span class="status-item">
        å¯¹è±¡: {{ objectCount }}
      </span>
    </div>
  </div>
</template>

<script>
import { ref, computed } from 'vue';
import { useScene } from '../../composables/useScene.js';
import { useObjectSelection } from '../../composables/useObjectSelection.js';
import { useTransform } from '../../composables/useTransform.js';
import { useObjectManager } from '../../core/ObjectManager.js';
import { exportJSON } from '../../utils/fileUtils.js';

export default {
  name: 'Toolbar',
  setup() {
    const scene = useScene();
    const objectSelection = useObjectSelection();
    const transform = useTransform();
    const objectManager = useObjectManager();
    
    // å“åº”å¼çŠ¶æ€
    const snapToGrid = ref(false);
    const showWireframe = ref(false);
    
    // è®¡ç®—å±æ€§
    const transformMode = computed(() => transform.transformMode.value);
    const selectionMode = computed(() => objectSelection.selectionMode.value);
    const hasSelection = computed(() => objectSelection.hasSelection.value);
    const selectionCount = computed(() => objectSelection.selectionCount.value);
    const fps = computed(() => scene.fps.value);
    const objectCount = computed(() => objectManager.getAllObjects().length);
    const canUndo = computed(() => transform.transformHistory.undoStack.length > 0);
    const canRedo = computed(() => transform.transformHistory.redoStack.length > 0);
    
    // æ–¹æ³•
    function newScene() {
      if (confirm('ç¡®å®šè¦æ–°å»ºåœºæ™¯å—ï¼Ÿè¿™å°†æ¸…é™¤å½“å‰æ‰€æœ‰å†…å®¹ã€‚')) {
        scene.clearScene();
        scene.resetScene();
        objectSelection.clearSelection();
        transform.clearHistory();
      }
    }
    
    function saveScene() {
      try {
        const sceneData = scene.exportScene();
        const filename = `scene_${new Date().toISOString().slice(0, 19).replace(/[:-]/g, '')}.json`;
        exportJSON(sceneData, filename);
      } catch (error) {
        console.error('ä¿å­˜åœºæ™¯å¤±è´¥:', error);
        alert('ä¿å­˜åœºæ™¯å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ§åˆ¶å°é”™è¯¯ä¿¡æ¯ã€‚');
      }
    }
    
    function loadScene() {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = '.json';
      input.onchange = async (event) => {
        const file = event.target.files[0];
        if (file) {
          try {
            const text = await file.text();
            const sceneData = JSON.parse(text);
            
            if (confirm('ç¡®å®šè¦åŠ è½½è¿™ä¸ªåœºæ™¯å—ï¼Ÿè¿™å°†æ›¿æ¢å½“å‰åœºæ™¯ã€‚')) {
              // TODO: å®ç°åœºæ™¯åŠ è½½é€»è¾‘
              console.log('åŠ è½½åœºæ™¯æ•°æ®:', sceneData);
              alert('åœºæ™¯åŠ è½½åŠŸèƒ½å¾…å®ç°');
            }
          } catch (error) {
            console.error('åŠ è½½åœºæ™¯å¤±è´¥:', error);
            alert('åŠ è½½åœºæ™¯å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æ ¼å¼ã€‚');
          }
        }
      };
      input.click();
    }
    
    function addPrimitive(type) {
      const position = [
        Math.random() * 4 - 2,
        Math.random() * 2,
        Math.random() * 4 - 2
      ];
      
      scene.createPrimitive(type, { position });
    }
    
    function setTransformMode(mode) {
      transform.transformMode.value = mode;
    }
    
    function setSelectionMode(mode) {
      objectSelection.selectionMode.value = mode;
    }
    
    function undo() {
      transform.undo();
    }
    
    function redo() {
      transform.redo();
    }
    
    function duplicateSelected() {
      objectManager.duplicateSelected();
    }
    
    function deleteSelected() {
      if (confirm('ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„å¯¹è±¡å—ï¼Ÿ')) {
        const selectedIds = Array.from(objectSelection.selectedObjectIds.value);
        selectedIds.forEach(id => {
          scene.removeObjectFromScene(id);
        });
        objectSelection.clearSelection();
      }
    }
    
    function focusSelected() {
      const selectedObjects = objectSelection.selectedObjects.value;
      if (selectedObjects.length > 0) {
        scene.focusOnObject(selectedObjects[0]);
      }
    }
    
    function resetCamera() {
      scene.updateCameraConfig({
        position: { x: 5, y: 5, z: 5 },
        target: { x: 0, y: 0, z: 0 }
      });
    }
    
    function updateSnapToGrid() {
      transform.transformConfig.snapToGrid = snapToGrid.value;
    }
    
    function updateWireframe() {
      // TODO: å®ç°çº¿æ¡†æ¨¡å¼åˆ‡æ¢
      console.log('çº¿æ¡†æ¨¡å¼:', showWireframe.value);
    }
    
    return {
      // çŠ¶æ€
      transformMode,
      selectionMode,
      hasSelection,
      selectionCount,
      fps,
      objectCount,
      canUndo,
      canRedo,
      snapToGrid,
      showWireframe,
      
      // æ–¹æ³•
      newScene,
      saveScene,
      loadScene,
      addPrimitive,
      setTransformMode,
      setSelectionMode,
      undo,
      redo,
      duplicateSelected,
      deleteSelected,
      focusSelected,
      resetCamera,
      updateSnapToGrid,
      updateWireframe
    };
  }
};
</script>

<style scoped>
.toolbar {
  height: 60px;
  background: #2a2a2a;
  border-bottom: 1px solid #444;
  display: flex;
  align-items: center;
  padding: 0 16px;
  gap: 16px;
  color: #fff;
  overflow-x: auto;
}

.toolbar-section {
  display: flex;
  align-items: center;
  gap: 8px;
  white-space: nowrap;
}

.section-label {
  font-size: 12px;
  color: #aaa;
  margin-right: 4px;
}

.toolbar-btn {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 2px;
  padding: 6px 8px;
  background: #333;
  border: 1px solid #555;
  border-radius: 4px;
  color: #fff;
  font-size: 10px;
  cursor: pointer;
  transition: all 0.2s;
  min-width: 50px;
}

.toolbar-btn:hover:not(:disabled) {
  background: #444;
  border-color: #666;
}

.toolbar-btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

.toolbar-btn.active {
  background: #007acc;
  border-color: #0088dd;
}

.toolbar-btn.danger {
  background: #d73a49;
  border-color: #e85662;
}

.toolbar-btn.danger:hover:not(:disabled) {
  background: #e85662;
}

.icon {
  font-size: 16px;
  line-height: 1;
}

.toolbar-divider {
  width: 1px;
  height: 30px;
  background: #555;
  margin: 0 8px;
}

.toggle-label {
  display: flex;
  align-items: center;
  gap: 4px;
  font-size: 12px;
  cursor: pointer;
}

.toggle-text {
  user-select: none;
}

.toolbar-status {
  margin-left: auto;
  display: flex;
  gap: 16px;
}

.status-item {
  font-size: 12px;
  color: #aaa;
  padding: 4px 8px;
  background: #333;
  border-radius: 4px;
}

/* ç§»åŠ¨ç«¯å“åº”å¼ */
@media (max-width: 768px) {
  .toolbar {
    height: auto;
    flex-wrap: wrap;
    padding: 8px;
    gap: 8px;
  }
  
  .toolbar-section {
    gap: 4px;
  }
  
  .toolbar-btn {
    min-width: 40px;
    padding: 4px 6px;
    font-size: 9px;
  }
  
  .icon {
    font-size: 14px;
  }
  
  .toolbar-status {
    width: 100%;
    margin-left: 0;
    justify-content: space-around;
  }
  
  .section-label {
    display: none;
  }
}
</style>

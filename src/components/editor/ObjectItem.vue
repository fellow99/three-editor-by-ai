<!--
  对象树节点组件
  递归渲染场景对象层级，支持选择、展开、可见性切换等
-->
<template>
  <div class="object-item" :style="{ paddingLeft: (level * 16 + 8) + 'px' }">
    <div 
      class="object-content"
      :class="{ 
        selected: isSelected, 
        highlighted: isHighlighted 
      }"
      @click="handleClick"
      @contextmenu="handleContextMenu"
    >
      <!-- 展开/折叠按钮 -->
      <button 
        v-if="hasChildren"
        @click.stop="toggleExpand"
        class="expand-btn"
        :class="{ expanded: isExpanded }"
      >
        ▶
      </button>
      <div v-else class="expand-spacer"></div>
      
      <!-- 对象图标 -->
      <span class="object-icon">{{ getObjectIcon(object) }}</span>
      
      <!-- 对象名称 -->
      <span class="object-name" :title="object.name">
        {{ object.name || '未命名对象' }}
      </span>
      
      <!-- 对象类型标签 -->
      <span v-if="objectType" class="object-type">{{ objectType }}</span>
      
      <!-- 锁定切换 -->
      <button
        @click.stop="toggleLock"
        class="lock-btn"
        :class="{ locked: object.userData.locked }"
        :title="object.userData.locked ? '解锁' : '锁定'"
      >
        {{ object.userData.locked ? '🔒' : '🔓' }}
      </button>
      <!-- 可见性切换 -->
      <button 
        @click.stop="toggleVisibility"
        class="visibility-btn"
        :class="{ hidden: !object.visible }"
        :title="object.visible ? '隐藏' : '显示'"
      >
        {{ object.visible ? '👁️' : '🙈' }}
      </button>
    </div>
    
    <!-- 子对象 -->
    <div v-if="hasChildren && isExpanded" class="children">
      <ObjectItem
        v-for="child in object.children"
        :key="child.userData.id || child.uuid"
        :object="child"
        :level="level + 1"
        :selected-ids="selectedIds"
        :expanded-ids="expandedIds"
        :search-query="searchQuery"
        @select="$emit('select', $event, $event)"
        @toggle-expand="$emit('toggle-expand', $event)"
        @toggle-visibility="$emit('toggle-visibility', $event)"
        @context-menu="$emit('context-menu', $event, $event)"
      />
    </div>
  </div>
</template>

<script>
import { computed } from 'vue';

export default {
  name: 'ObjectItem',
  emits: ['select', 'toggle-expand', 'toggle-visibility', 'context-menu', 'toggle-lock'],
  props: {
    object: {
      type: Object,
      required: true
    },
    level: {
      type: Number,
      default: 0
    },
    selectedIds: {
      type: Array,
      default: () => []
    },
    expandedIds: {
      type: Set,
      default: () => new Set()
    },
    searchQuery: {
      type: String,
      default: ''
    }
  },
  /**
   * 对象树节点组件
   * 递归渲染场景对象层级，支持选择、展开、可见性切换等
   */
  setup(props, { emit }) {
    // 计算属性
    const isSelected = computed(() => 
      props.selectedIds.includes(props.object.userData.id)
    );
    
    const isExpanded = computed(() => 
      props.expandedIds.has(props.object.userData.id)
    );
    
    const hasChildren = computed(() => 
      props.object.children && props.object.children.length > 0
    );
    
    const objectType = computed(() => {
      if (props.object.userData.type) {
        return props.object.userData.type;
      }
      if (props.object.userData.primitiveType) {
        return props.object.userData.primitiveType;
      }
      if (props.object.isGroup) {
        return 'Group';
      }
      if (props.object.isMesh) {
        return 'Mesh';
      }
      if (props.object.isLight) {
        return 'Light';
      }
      if (props.object.isCamera) {
        return 'Camera';
      }
      return null;
    });
    
    const isHighlighted = computed(() => {
      if (!props.searchQuery) return false;
      const query = props.searchQuery.toLowerCase();
      return props.object.name.toLowerCase().includes(query) ||
             (objectType.value && objectType.value.toLowerCase().includes(query));
    });
    
    // 方法
    /**
     * 获取对象类型对应的图标
     * @param {Object} object Three.js对象
     * @returns {string} 图标
     */
    function getObjectIcon(object) {
      if (object.userData.primitiveType) {
        switch (object.userData.primitiveType) {
          case 'box': return '⬜';
          case 'sphere': return '⚪';
          case 'cylinder': return '🥫';
          case 'plane': return '▭';
          default: return '📦';
        }
      }
      
      if (object.isGroup) return '📁';
      if (object.isMesh) return '📦';
      if (object.isLight) {
        if (object.isDirectionalLight) return '☀️';
        if (object.isPointLight) return '💡';
        if (object.isSpotLight) return '🔦';
        return '💡';
      }
      if (object.isCamera) {
        if (object.isPerspectiveCamera) return '📷';
        if (object.isOrthographicCamera) return '📹';
        return '📷';
      }
      
      return '🔸';
    }
    
    /**
     * 处理节点点击，触发选择
     * @param {Event} event 鼠标事件
     */
    function handleClick(event) {
      emit('select', props.object, event);
    }
    
    /**
     * 处理右键菜单事件
     * @param {Event} event 鼠标事件
     */
    function handleContextMenu(event) {
      emit('context-menu', props.object, event);
    }
    
    /**
     * 展开/折叠子节点
     */
    function toggleExpand() {
      if (hasChildren.value) {
        emit('toggle-expand', props.object.userData.id);
      }
    }
    
    /**
     * 切换对象可见性
     */
    function toggleVisibility() {
      emit('toggle-visibility', props.object);
    }
    
    /**
     * 切换对象锁定状态
     */
    function toggleLock() {
      emit('toggle-lock', props.object);
    }

    return {
      // 计算属性
      isSelected,
      isExpanded,
      hasChildren,
      objectType,
      isHighlighted,
      
      // 方法
      getObjectIcon,
      handleClick,
      handleContextMenu,
      toggleExpand,
      toggleVisibility,
      toggleLock
    };
  }
};
</script>

<style lang="scss" scoped>
.object-item {
  user-select: none;
}

.object-content {
  display: flex;
  align-items: center;
  gap: 4px;
  padding: 4px 8px;
  border-radius: 4px;
  cursor: pointer;
  transition: background-color 0.2s;
  min-height: 24px;
}

.object-content:hover {
  background: #444;
}

.object-content.selected {
  background: #007acc;
}

.object-content.highlighted {
  background: #4a4a00;
}

.object-content.selected.highlighted {
  background: #005588;
}

.expand-btn {
  width: 16px;
  height: 16px;
  border: none;
  background: none;
  color: #aaa;
  cursor: pointer;
  font-size: 10px;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: transform 0.2s;
}

.expand-btn.expanded {
  transform: rotate(90deg);
}

.expand-btn:hover {
  color: #fff;
}

.expand-spacer {
  width: 16px;
  height: 16px;
}

.object-icon {
  font-size: 14px;
  width: 16px;
  text-align: center;
}

.object-name {
  flex: 1;
  font-size: 12px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  min-width: 0;
}

.object-type {
  font-size: 9px;
  color: #aaa;
  background: #555;
  padding: 2px 4px;
  border-radius: 2px;
  text-transform: uppercase;
}

.visibility-btn {
  width: 20px;
  height: 20px;
  border: none;
  background: none;
  cursor: pointer;
  font-size: 10px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 2px;
  transition: background-color 0.2s;
}

.visibility-btn:hover {
  background: #555;
}

.visibility-btn.hidden {
  opacity: 0.5;
}

.children {
  border-left: 1px solid #444;
  margin-left: 8px;
}

/* 搜索高亮效果 */
.object-content.highlighted .object-name {
  background: linear-gradient(90deg, transparent, #ffff0030, transparent);
  animation: highlight-pulse 2s ease-in-out infinite;
}

@keyframes highlight-pulse {
  0%, 100% { background-position: -100% 0; }
  50% { background-position: 100% 0; }
}
</style>

<!--
  对象检查器
  查看和操作场景中的对象，包括层级、属性统计、搜索和右键菜单操作
-->
<template>
  <div class="inspector">
    <!-- 搜索框 -->
    <div class="search-section">
      <div class="search-box">
        <input 
          v-model="searchQuery" 
          type="text" 
          placeholder="搜索对象..."
          class="search-input"
        >
        <span class="search-icon">🔍</span>
      </div>
      <div class="toolbar-row">
        <button @click="refreshHierarchy" class="toolbar-btn" title="刷新层级">
          <span class="icon">🔄</span>
        </button>
        <button @click="expandAll" class="toolbar-btn" title="展开所有">
          <span class="icon">📂</span>
        </button>
        <button @click="collapseAll" class="toolbar-btn" title="折叠所有">
          <span class="icon">📁</span>
        </button>
        <button @click="showOnlyVisible = !showOnlyVisible" :class="['toolbar-btn', { active: showOnlyVisible }]" title="仅显示可见对象">
          <span class="icon">👁️</span>
        </button>
        <button @click="showOnlySelected = !showOnlySelected" :class="['toolbar-btn', { active: showOnlySelected }]" title="仅显示选中对象">
          <span class="icon">✅</span>
        </button>
      </div>
    </div>

    <!-- 层级树 -->
    <div class="hierarchy-tree">
      <div v-if="filteredObjects.length === 0" class="empty-hierarchy">
        <p>场景中没有对象</p>
        <p class="hint">从工具栏添加基础几何体或从资源浏览器拖入模型</p>
      </div>
      
      <div v-else class="object-list">
        <ObjectItem
          v-for="object in filteredObjects"
          :key="object.userData.id || object.uuid"
          :object="object"
          :level="0"
          :selected-ids="selectedObjectIds"
          :expanded-ids="expandedIds"
          :search-query="searchQuery"
          @select="handleObjectSelect"
          @toggle-expand="handleToggleExpand"
          @toggle-visibility="handleToggleVisibility"
          @toggle-lock="handleToggleLock"
          @context-menu="handleContextMenu"
        />
      </div>
    </div>

    <!-- 右键菜单 -->
    <div 
      v-if="contextMenu.visible" 
      class="context-menu"
      :style="{ 
        left: contextMenu.x + 'px', 
        top: contextMenu.y + 'px' 
      }"
      @click.stop
    >
      <div class="context-item" @click="duplicateObject(contextMenu.object)">
        <span class="context-icon">📋</span>
        复制对象
      </div>
      <div class="context-item" @click="deleteObject(contextMenu.object)">
        <span class="context-icon">🗑️</span>
        删除对象
      </div>
      <div class="context-divider"></div>
      <div class="context-item" @click="isolateObject(contextMenu.object)">
        <span class="context-icon">👁️</span>
        隔离显示
      </div>
      <div class="context-item" @click="focusObject(contextMenu.object)">
        <span class="context-icon">🎯</span>
        聚焦对象
      </div>
      <div class="context-divider"></div>
      <div class="context-item" @click="renameObject(contextMenu.object)">
        <span class="context-icon">✏️</span>
        重命名
      </div>
    </div>

    <!-- 背景点击遮罩 -->
    <div 
      v-if="contextMenu.visible" 
      class="context-overlay"
      @click="hideContextMenu"
    ></div>
  </div>
</template>

<script>
import { ref, reactive, computed, onMounted, onUnmounted } from 'vue';
import { useScene } from '../../composables/useScene.js';
import { useObjectSelection } from '../../composables/useObjectSelection.js';
import { useObjectManager } from '../../core/ObjectManager.js';
import ObjectItem from './ObjectItem.vue';

export default {
  name: 'Inspector',
  components: {
    ObjectItem
  },
  emits: ['delete-selected'],
  /**
   * 对象检查器组件
   * 展示场景对象层级、属性统计及对象操作
   */
  setup(props, { emit }) {
    const scene = useScene();
    const objectSelection = useObjectSelection();
    const objectManager = useObjectManager();
    
    // 响应式状态
    const searchQuery = ref('');
    const showOnlyVisible = ref(false);
    const showOnlySelected = ref(false);
    const expandedIds = reactive(new Set());
    const contextMenu = reactive({
      visible: false,
      x: 0,
      y: 0,
      object: null
    });
    
    // 计算属性
    const allObjects = computed(() => objectManager.getAllObjects());
    const selectedObjectIds = computed(() => objectSelection.selectedObjectIds.value);

    const filteredObjects = computed(() => {
      let objects = allObjects.value;
      
      // 搜索过滤
      if (searchQuery.value) {
        const query = searchQuery.value.toLowerCase();
        objects = objects.filter(obj => 
          obj.name.toLowerCase().includes(query) ||
          (obj.userData.type && obj.userData.type.toLowerCase().includes(query))
        );
      }
      
      // 可见性过滤
      if (showOnlyVisible.value) {
        objects = objects.filter(obj => obj.visible);
      }
      
      // 选中状态过滤
      if (showOnlySelected.value) {
        objects = objects.filter(obj => 
          selectedObjectIds.value.includes(obj.userData.id)
        );
      }
      
      return objects;
    });
    
    // 方法
    /**
     * 强制刷新层级树展开状态
     */
    function refreshHierarchy() {
      // 强制更新层级树
      const currentExpanded = Array.from(expandedIds);
      expandedIds.clear();
      setTimeout(() => {
        currentExpanded.forEach(id => expandedIds.add(id));
      }, 0);
    }
    
    /**
     * 展开所有对象
     */
    function expandAll() {
      allObjects.value.forEach(obj => {
        if (obj.userData.id) {
          expandedIds.add(obj.userData.id);
        }
      });
    }
    
    /**
     * 折叠所有对象
     */
    function collapseAll() {
      expandedIds.clear();
    }
    
    /**
     * 处理对象选择（支持多选、范围选）
     * @param {Object} object 选中对象
     * @param {Event} event 事件对象
     */
    function handleObjectSelect(object, event) {
      const isMultiSelect = event.ctrlKey || event.metaKey;
      const isRangeSelect = event.shiftKey;
      
      if (isRangeSelect) {
        // TODO: 实现范围选择
        objectSelection.selectObject(object, true);
      } else if (isMultiSelect) {
        objectSelection.toggleSelection(object);
      } else {
        objectSelection.selectObject(object);
      }
    }
    
    /**
     * 展开/折叠对象
     * @param {string} objectId 对象ID
     */
    function handleToggleExpand(objectId) {
      if (expandedIds.has(objectId)) {
        expandedIds.delete(objectId);
      } else {
        expandedIds.add(objectId);
      }
    }
    
    /**
     * 切换对象可见性
     * @param {Object} object 目标对象
     */
    function handleToggleVisibility(object) {
      object.visible = !object.visible;
    }
    
    /**
     * 显示右键菜单
     * @param {Object} object 目标对象
     * @param {Event} event 鼠标事件
     */
    function handleContextMenu(object, event) {
      event.preventDefault();
      contextMenu.visible = true;
      contextMenu.x = event.clientX;
      contextMenu.y = event.clientY;
      contextMenu.object = object;
    }
    
    /**
     * 隐藏右键菜单
     */
    function hideContextMenu() {
      contextMenu.visible = false;
      contextMenu.object = null;
    }
    
    /**
     * 复制对象
     * @param {Object} object 目标对象
     */
    function duplicateObject(object) {
      objectManager.copyObjects([object.userData.id]);
      const duplicated = objectManager.pasteObjects();
      if (duplicated.length > 0) {
        objectSelection.selectObject(duplicated[0]);
      }
      hideContextMenu();
    }
    
    /**
     * 删除对象
     * @param {Object} object 目标对象
     */
    function deleteObject(object) {
      emit('delete-selected', object);
      hideContextMenu();
    }
    
    /**
     * 隔离显示对象（只显示该对象）
     * @param {Object} object 目标对象
     */
    function isolateObject(object) {
      // 隐藏其他所有对象，只显示选中的对象
      allObjects.value.forEach(obj => {
        obj.visible = obj === object;
      });
      hideContextMenu();
    }
    
    /**
     * 聚焦对象
     * @param {Object} object 目标对象
     */
    function focusObject(object) {
      scene.focusOnObject(object);
      objectSelection.selectObject(object);
      hideContextMenu();
    }
    
    /**
     * 重命名对象
     * @param {Object} object 目标对象
     */
    function renameObject(object) {
      const newName = prompt('请输入新名称:', object.name);
      if (newName && newName.trim()) {
        object.name = newName.trim();
      }
      hideContextMenu();
    }
    
    // 监听全局点击事件来隐藏右键菜单
    /**
     * 监听全局点击事件，隐藏右键菜单
     */
    function handleGlobalClick() {
      if (contextMenu.visible) {
        hideContextMenu();
      }
    }
    
    onMounted(() => {
      document.addEventListener('click', handleGlobalClick);
    });
    
    onUnmounted(() => {
      document.removeEventListener('click', handleGlobalClick);
    });
    
    /**
     * 切换对象锁定状态
     * @param {Object} object 目标对象
     */
    function handleToggleLock(object) {
      object.userData.locked = !object.userData.locked;
      // 锁定后取消选择
      if (object.userData.locked) {
        objectSelection.deselectObject(object);
      }
    }

    return {
      // 状态
      searchQuery,
      showOnlyVisible,
      showOnlySelected,
      expandedIds,
      contextMenu,
      allObjects,
      selectedObjectIds,
      filteredObjects,
      // 多选辅助对象集合，便于调试和扩展
      currentHelpers: objectSelection.currentHelpers,
      
      // 方法
      refreshHierarchy,
      expandAll,
      collapseAll,
      handleObjectSelect,
      handleToggleExpand,
      handleToggleVisibility,
      handleToggleLock,
      handleContextMenu,
      hideContextMenu,
      duplicateObject,
      deleteObject,
      isolateObject,
      focusObject,
      renameObject
    };
  }
};
</script>

<style lang="scss" scoped>
.inspector {
  width: 100%;
  height: 100%;
  background: #2a2a2a;
  border-right: 1px solid #444;
  display: flex;
  flex-direction: column;
  color: #fff;
}

.toolbar-row {
  display: flex;
  gap: 8px;
  margin-bottom: 0;
  margin-top: 0;
}

.toolbar-btn {
  padding: 4px 10px;
  background: #444;
  border: none;
  border-radius: 4px;
  color: #fff;
  font-size: 12px;
  cursor: pointer;
  transition: background 0.2s, color 0.2s;
}

.toolbar-btn.active {
  background: #007acc;
  color: #fff;
}

.toolbar-btn:hover {
  background: #0088dd;
  color: #fff;
}

.scene-stats {
  padding: 12px 16px;
  border-bottom: 1px solid #444;
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 8px;
}

.stat-item {
  display: flex;
  justify-content: space-between;
  font-size: 11px;
}

.stat-label {
  color: #aaa;
}

.stat-value {
  color: #fff;
  font-weight: 600;
}

.search-section {
  padding: 12px 16px;
  border-bottom: 1px solid #444;
}

.search-box {
  position: relative;
  margin-bottom: 12px;
}

.search-input {
  width: 100%;
  padding: 8px 32px 8px 12px;
  background: #333;
  border: 1px solid #555;
  border-radius: 4px;
  color: #fff;
  font-size: 12px;
}

.search-input:focus {
  outline: none;
  border-color: #007acc;
}

.search-icon {
  position: absolute;
  right: 8px;
  top: 50%;
  transform: translateY(-50%);
  color: #aaa;
  font-size: 12px;
}

/* filter-options和filter-checkbox相关样式已移除 */

.hierarchy-tree {
  flex: 1;
  overflow-y: auto;
  padding: 8px;
}

.empty-hierarchy {
  padding: 40px 20px;
  text-align: center;
  color: #aaa;
}

.empty-hierarchy .hint {
  font-size: 11px;
  margin-top: 8px;
  line-height: 1.4;
}

.object-list {
  display: flex;
  flex-direction: column;
  gap: 2px;
}

.context-menu {
  position: fixed;
  background: #333;
  border: 1px solid #555;
  border-radius: 4px;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
  z-index: 1000;
  min-width: 150px;
  padding: 4px 0;
}

.context-item {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 8px 12px;
  font-size: 12px;
  cursor: pointer;
  transition: background-color 0.2s;
}

.context-item:hover {
  background: #444;
}

.context-icon {
  font-size: 14px;
}

.context-divider {
  height: 1px;
  background: #555;
  margin: 4px 0;
}

.context-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  z-index: 999;
}
</style>
